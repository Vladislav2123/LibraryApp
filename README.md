## Обзор
__LibraryApp__ это простая онлайн-библиотека. В ней пользователи могут просматривать авторов, читать и оценивать книги.

## Цели
Проект разрабатывался для __получения навыков и практического опыта__ в разработке, тестировании и контейнеризации __Web API__.  
Я не хотел, чтобы проект решал какую-то проблему и был полезен мне или другим людям.  

Я хотел разработать такой __проект__, который __имеет__:
- Хорошую архитектуру
- Все CRUD операции
- Валидацию данных и запросов 
- Логирование
- Сохранение и отправку файлов
- Кеширование Redis
- JWT аутентификацию 
- Безопасное хранение паролей 
- Юнит тесты

Также я хотел углубленно изучить __Postman__ и __Docker__.

## Функционал
#### Просмотр книг и авторов
Пользователи могут просматривать книги и авторов, сортируя и фильтруя список по различным критериям. Также предусмотрены пагинация и поиск по названию или имени автора.

#### Чтение книг
Пользователи могут читать книги, скачивая их в __PDF__ формате.

#### Список прочитанных
Пользователи могут добавлять книги в свой список прочитанных. Этот список доступен для просмотра всем пользователям.

#### Оценивание книг
Пользователи могут оценивать книги по шкале от 1 до 5. Оценка также может включать в себя заголовок и комментарий.

#### Изображения
При желании пользователь может добавить или поменять аватар. Изображения также могут быть у книг и авторов.  
Поддерживаются __JPG__ и __PNG__ форматы.

#### Роли пользователей
В проекте имеются две роли пользователей: администратор и обычный пользователь.  
Администраторы обладают расширенными правами:
- Cоздание, удалениe и редактирование книг и авторов.
- Удаление пользователей, их аватаров и комментариев в целях модерации контента. 

## Техническое устройтсво
### Технологии и библиотеки
При разработке данного проекта я использовал следующие технологии и библиотеки:
- C#
- Git
- .NET 7
- ASP.NET
- EF Сore
- Microsoft SQL Server
- PostgreSQL
- Redis
- MediatR
- AutoMapper
- FluentValidation
- Serilog
- JWT Authentication
- xUnit
- FluentAssertions
- Moq
- Postman
- Docker  

---

### Функционал
#### Обработка запросов
Эндпоинты определены в __API контроллерах__. Запросы обрабатываются используя паттерн __SQRS__ и библиотеку __MediatR__.

#### Валидация
Валидация реализована с помощью библиотек __FluentValidation__ и __MediatR__.
В проекте автоматически валидируются все запросы, изменяющие состояние сущностей. Это реализованно с помощью __Validation Behavior__, основанном на __MediatR.IPipelineBahavior__.

#### Логирование 
Логирвание реализовано с помощью библиотек __Serilog__ и __MediatR__.
В проекте логируются все запросы и ошибки. Запросы логируются с помощью __Logging Behavior__, основанном на __MediatR.IValidationBehavior__.

#### Обработка исключений
Для обработки исключений предусмотрен __Middleware__, в котором ошибка логируется и клиенту отправляется соответсвтующий ответ.

#### Aутентификация, авторизация и безопасность
Аутентификация и авторизация основана на __JWT-токенах__. 
В проекте есть несколько __Policies__ для ограничения доступа к эндпоинтам.  
Пользователь может зарегестрироваться с помощью Email и пароля. __Пароль хэшируется функцией BCrypt__ с помощью __Salt__ и __Pepper__ (то же, что и salt, но общий для всех пользователей и хранится на сервере).  

#### База данных
Изначально базой данных в проекте был __Microsoft SQL Server__. Но, из-за трудностей при запуске проекта в docker-compose, было решено перейти на __PostgreSQL__. Это сразу решило проблему.  

#### Хранение файлов
Все файлы, такие как аватары пользователей, аватары авторов, обложки книг и их содержимое хранятся в файловой системе сервера. 

---

### Структура решения
Для чистоты архитектуры, решение разделено на проекты.

#### [src/Core/LibraryApp.Domain][Domain]
Содержит сущности проекта и исключения.
    
#### [src/Core/LibraryApp.Application][Application]
Содержит бизнес логику проекта: обработку запросов, пагинацию, абстракции и др.
    
#### [src/Infrastructure/LibraryApp.DAL][DAL]
Содержит логику взаимодействия с базой данных: DbContext, EntityTypeConfiguration, DbInitializer и др.

#### [src/Presentation/LibraryApp.API][API]
Является главным Web API проектом. Содержит контроллеры, код для аутентификации и авторизации, а также GlobalExceptionsHandler.

#### [src/Tests/LibraryApp.Tests][Tests]
Содержит юнит тесты.

## Запуск и тестирование
### Важно
- Для удобства тестирования, при повторном запуске проекта __база данных очищается__.  
- Тестировать проект лучше в __Postman__, по инструкции ниже.
- При запуске проекта автоматически создается пользователь с правами администратора.  
  Данные для входа (определены в [appsettings.json][appsettings]):
    - Email: adminmail@gmail.com 
    - Password: Admin12345
    
---

### Локальный запуск в Visual Studio
Для локального запуска необходимо:
- Иметь на компьютере .NET 7 и запущенный PostgreSQL с открытым портом __5432__.
- В [appsettings.json][appsettings] поменять __DbPassword__ на ваш пароль от PostgreSQL.

При успешном запуске должен открыться браузер с __Swagger UI__, где вы можете протестировать проект.  
Если этого не случилось, Вы можете открыть его сами, перейдя по ссылке: https://localhost:5001/swagger.  
Также Вы можете протестировать проект в __Postman__, по инструкции ниже.

---

### Запуск в Docker
Для запуска проекта в Docker необходимо:
- Открыть терминал и перейти в директорию с файлом docker-compose.yaml (корневая папка проекта).
- Выполнить команду ```docker-compose build``` и дождаться сборки проекта.
- Выполнить команду ```docker-compose up``` и дождаться полного запуска контейнеров.

По умолчанию создается контейнер __PostgreSQL__ с паролем __"StrongPassword"__. Вы можете установить другой пароль, вписав его в поля __"POSTGRES_PASSWORD"__ и __"DB_PASSWORD"__ в файле docker-compose.yaml. Но это не обязательно.

Вы можете открыть __Swagger UI__ для тестирования проекта, перейдя по ссылке: https://localhost:5001/swagger.  
Также Вы можете протестировать проект в __Postman__, по инструкции ниже.

---

### Тестирование в Postman
В папке __[assets/Postman][Postman]__ находятся необходимые файлы для тестирования в __Postman__: 
- __LibraryApp.postman_collection.json__ и __LibraryAppEnv.postman_environment.json__
- Изображения: аватар пользователя, аватар автора и обложка книги
- PDF файл книги 

Файлы __LibraryApp.postman_collection.json__ и __LibraryAppEnv.postman_environment.json__ необходимо импортировать в __Postman__.  
Остальные файлы нужно вставить в тела запросов: 
- Update User Avatar
- Update Author Avatar
- Create Book
- Update Book Cover

Все запросы настроены и имеют тесты. ID создаваемых сущностей записываются в __Environment variables__ и используются в других запросах, касаемых этих сущностей. Также, при выполнении запроса на Login, в __Environment variables__ записывается JWT-токен доступа и ID пользователя, в профиль которого выполнен вход.

## Вывод
 Я считаю, что интересующие меня навыки и технологии изучены достаточно для дальнейшего применения в работе.  
 Следовательно, я считаю, что __поставленные мной цели достигнуты__.
 
 [Domain]: https://github.com/Vladislav2123/LibraryApp/tree/master/src/Core/LibraryApp.Domain
 [Application]: https://github.com/Vladislav2123/LibraryApp/tree/master/src/Core/LibraryApp.Application
 [DAL]: https://github.com/Vladislav2123/LibraryApp/tree/master/src/Infrastructure/LibraryApp.DAL
 [API]: https://github.com/Vladislav2123/LibraryApp/tree/master/src/Presentation/LibraryApp.API
 [Tests]: https://github.com/Vladislav2123/LibraryApp/tree/master/src/Tests/LibraryApp.Tests
 [Postman]: https://github.com/Vladislav2123/LibraryApp/tree/master/assets/Postman
 [appsettings]: https://github.com/Vladislav2123/LibraryApp/blob/master/src/Presentation/LibraryApp.API/appsettings.json
